-- LENNY HUB - ENHANCED VERSION WITH FIXES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")
local HttpService = game:GetService("HttpService")
local StarterGui = game:GetService("StarterGui")
local TextService = game:GetService("TextService")

local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

-- VERSION AND UPDATE SYSTEM
local SCRIPT_VERSION = "2.2.0"
local LAST_UPDATE_VERSION = "2.2.0"
local UPDATE_LOGS = {
    "ðŸŽ¯ Fixed aimbot targeting system",
    "ðŸ“¦ Added 2D Box ESP for full body coverage",
    "ðŸ”§ Fixed FOV circle positioning",
    "âœ¨ Enhanced UI polish and animations",
    "ðŸŽ® Improved legit mode functionality",
    "âš¡ Optimized performance"
}

-- Check if this is a new update
local function isNewUpdate()
    local success, lastVersion = pcall(function()
        return readfile("LennyHub_LastVersion.txt")
    end)
    return not success or lastVersion ~= LAST_UPDATE_VERSION
end

-- Save current version
local function saveCurrentVersion()
    pcall(function()
        writefile("LennyHub_LastVersion.txt", LAST_UPDATE_VERSION)
    end)
end

-- // KEY SYSTEM //
local CORRECT_KEY = "Elena"
local KeyAuthorized = false

local KeyGui = Instance.new("ScreenGui")
KeyGui.Name = "KeySystem"
KeyGui.ResetOnSpawn = false
KeyGui.IgnoreGuiInset = true
if gethui then KeyGui.Parent = gethui() else KeyGui.Parent = CoreGui end

local KeyBg = Instance.new("Frame", KeyGui)
KeyBg.Size = UDim2.new(1, 0, 1, 0)
KeyBg.BackgroundColor3 = Color3.fromRGB(10, 10, 15)
KeyBg.BackgroundTransparency = 0.3
KeyBg.BorderSizePixel = 0

local KeyFrame = Instance.new("Frame", KeyBg)
KeyFrame.Size = UDim2.new(0, 350, 0, 200)
KeyFrame.Position = UDim2.new(0.5, -175, 0.5, -100)
KeyFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
KeyFrame.BorderSizePixel = 0

local KeyFrameCorner = Instance.new("UICorner", KeyFrame)
KeyFrameCorner.CornerRadius = UDim.new(0, 12)

local KeyFrameStroke = Instance.new("UIStroke", KeyFrame)
KeyFrameStroke.Color = Color3.fromRGB(147, 51, 234)
KeyFrameStroke.Thickness = 2

local KeyTitle = Instance.new("TextLabel", KeyFrame)
KeyTitle.Size = UDim2.new(1, 0, 0, 50)
KeyTitle.BackgroundTransparency = 1
KeyTitle.Text = "LENNY HUB v" .. SCRIPT_VERSION .. " - KEY SYSTEM"
KeyTitle.TextColor3 = Color3.fromRGB(147, 51, 234)
KeyTitle.Font = Enum.Font.GothamBlack
KeyTitle.TextSize = 18

local KeySubtitle = Instance.new("TextLabel", KeyFrame)
KeySubtitle.Size = UDim2.new(1, -40, 0, 20)
KeySubtitle.Position = UDim2.new(0, 20, 0, 55)
KeySubtitle.BackgroundTransparency = 1
KeySubtitle.Text = "Enter the key to continue"
KeySubtitle.TextColor3 = Color3.fromRGB(200, 200, 200)
KeySubtitle.Font = Enum.Font.Gotham
KeySubtitle.TextSize = 12

local KeyInput = Instance.new("TextBox", KeyFrame)
KeyInput.Size = UDim2.new(1, -40, 0, 40)
KeyInput.Position = UDim2.new(0, 20, 0, 85)
KeyInput.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
KeyInput.BorderSizePixel = 0
KeyInput.PlaceholderText = "Enter Key..."
KeyInput.PlaceholderColor3 = Color3.fromRGB(150, 150, 150)
KeyInput.Text = ""
KeyInput.TextColor3 = Color3.new(1, 1, 1)
KeyInput.Font = Enum.Font.Gotham
KeyInput.TextSize = 14
KeyInput.ClearTextOnFocus = false

local KeyInputCorner = Instance.new("UICorner", KeyInput)
KeyInputCorner.CornerRadius = UDim.new(0, 8)

local KeyInputStroke = Instance.new("UIStroke", KeyInput)
KeyInputStroke.Color = Color3.fromRGB(147, 51, 234)
KeyInputStroke.Thickness = 1
KeyInputStroke.Transparency = 0.5

local SubmitBtn = Instance.new("TextButton", KeyFrame)
SubmitBtn.Size = UDim2.new(1, -40, 0, 40)
SubmitBtn.Position = UDim2.new(0, 20, 0, 140)
SubmitBtn.BackgroundColor3 = Color3.fromRGB(147, 51, 234)
SubmitBtn.Text = "SUBMIT"
SubmitBtn.TextColor3 = Color3.new(1, 1, 1)
SubmitBtn.Font = Enum.Font.GothamBold
SubmitBtn.TextSize = 14
SubmitBtn.AutoButtonColor = false

local SubmitCorner = Instance.new("UICorner", SubmitBtn)
SubmitCorner.CornerRadius = UDim.new(0, 8)

local StatusLabel = Instance.new("TextLabel", KeyFrame)
StatusLabel.Size = UDim2.new(1, -40, 0, 20)
StatusLabel.Position = UDim2.new(0, 20, 0, 185)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Text = ""
StatusLabel.TextColor3 = Color3.fromRGB(239, 68, 68)
StatusLabel.Font = Enum.Font.Gotham
StatusLabel.TextSize = 11
StatusLabel.Visible = false

local function ValidateKey()
    local enteredKey = KeyInput.Text
    
    if enteredKey == CORRECT_KEY then
        StatusLabel.TextColor3 = Color3.fromRGB(34, 197, 94)
        StatusLabel.Text = "Key Accepted! Loading..."
        StatusLabel.Visible = true
        SubmitBtn.BackgroundColor3 = Color3.fromRGB(34, 197, 94)
        
        wait(1)
        KeyAuthorized = true
        KeyGui:Destroy()
        StartMainScript()
    else
        StatusLabel.TextColor3 = Color3.fromRGB(239, 68, 68)
        StatusLabel.Text = "Invalid Key! Try again."
        StatusLabel.Visible = true
        SubmitBtn.BackgroundColor3 = Color3.fromRGB(239, 68, 68)
        
        TweenService:Create(KeyFrame, TweenInfo.new(0.1, Enum.EasingStyle.Linear, Enum.EasingDirection.InOut, 0, true), 
            {Position = UDim2.new(0.5, -165, 0.5, -100)}):Play()
        
        wait(0.2)
        KeyFrame.Position = UDim2.new(0.5, -175, 0.5, -100)
        SubmitBtn.BackgroundColor3 = Color3.fromRGB(147, 51, 234)
        
        wait(2)
        StatusLabel.Visible = false
        KeyInput.Text = ""
    end
end

SubmitBtn.MouseButton1Click:Connect(ValidateKey)
KeyInput.FocusLost:Connect(function(enterPressed)
    if enterPressed then ValidateKey() end
end)

SubmitBtn.MouseEnter:Connect(function()
    TweenService:Create(SubmitBtn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(170, 70, 255)}):Play()
end)

SubmitBtn.MouseLeave:Connect(function()
    TweenService:Create(SubmitBtn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(147, 51, 234)}):Play()
end)

-- // UPDATE NOTIFICATION FUNCTION //
local function ShowUpdateNotification()
    if not isNewUpdate() then return end
    
    local UpdateGui = Instance.new("ScreenGui")
    UpdateGui.Name = "UpdateNotification"
    UpdateGui.ResetOnSpawn = false
    UpdateGui.IgnoreGuiInset = true
    if gethui then UpdateGui.Parent = gethui() else UpdateGui.Parent = CoreGui end
    
    local UpdateBg = Instance.new("Frame", UpdateGui)
    UpdateBg.Size = UDim2.new(1, 0, 1, 0)
    UpdateBg.BackgroundColor3 = Color3.fromRGB(10, 10, 15)
    UpdateBg.BackgroundTransparency = 0.3
    UpdateBg.BorderSizePixel = 0
    
    local UpdateFrame = Instance.new("Frame", UpdateBg)
    UpdateFrame.Size = UDim2.new(0, 400, 0, 450)
    UpdateFrame.Position = UDim2.new(0.5, -200, 0.5, -225)
    UpdateFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
    UpdateFrame.BorderSizePixel = 0
    
    local UpdateCorner = Instance.new("UICorner", UpdateFrame)
    UpdateCorner.CornerRadius = UDim.new(0, 12)
    
    local UpdateStroke = Instance.new("UIStroke", UpdateFrame)
    UpdateStroke.Color = Color3.fromRGB(59, 130, 246)
    UpdateStroke.Thickness = 2
    
    local UpdateTitle = Instance.new("TextLabel", UpdateFrame)
    UpdateTitle.Size = UDim2.new(1, -60, 0, 40)
    UpdateTitle.Position = UDim2.new(0, 30, 0, 15)
    UpdateTitle.BackgroundTransparency = 1
    UpdateTitle.Text = "ðŸŽ‰ LENNY HUB UPDATED!"
    UpdateTitle.TextColor3 = Color3.fromRGB(59, 130, 246)
    UpdateTitle.Font = Enum.Font.GothamBlack
    UpdateTitle.TextSize = 20
    UpdateTitle.TextXAlignment = Enum.TextXAlignment.Left
    
    local VersionLabel = Instance.new("TextLabel", UpdateFrame)
    VersionLabel.Size = UDim2.new(1, -60, 0, 25)
    VersionLabel.Position = UDim2.new(0, 30, 0, 55)
    VersionLabel.BackgroundTransparency = 1
    VersionLabel.Text = "Version " .. SCRIPT_VERSION
    VersionLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    VersionLabel.Font = Enum.Font.Gotham
    VersionLabel.TextSize = 14
    VersionLabel.TextXAlignment = Enum.TextXAlignment.Left
    
    local CloseBtn = Instance.new("TextButton", UpdateFrame)
    CloseBtn.Size = UDim2.new(0, 30, 0, 30)
    CloseBtn.Position = UDim2.new(1, -35, 0, 15)
    CloseBtn.BackgroundColor3 = Color3.fromRGB(239, 68, 68)
    CloseBtn.Text = "Ã—"
    CloseBtn.TextColor3 = Color3.new(1, 1, 1)
    CloseBtn.Font = Enum.Font.GothamBlack
    CloseBtn.TextSize = 20
    CloseBtn.AutoButtonColor = false
    
    local CloseCorner = Instance.new("UICorner", CloseBtn)
    CloseCorner.CornerRadius = UDim.new(0, 6)
    
    local UpdateList = Instance.new("ScrollingFrame", UpdateFrame)
    UpdateList.Size = UDim2.new(1, -40, 0, 320)
    UpdateList.Position = UDim2.new(0, 20, 0, 90)
    UpdateList.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
    UpdateList.BorderSizePixel = 0
    UpdateList.ScrollBarThickness = 4
    UpdateList.ScrollBarImageColor3 = Color3.fromRGB(59, 130, 246)
    
    local ListCorner = Instance.new("UICorner", UpdateList)
    ListCorner.CornerRadius = UDim.new(0, 8)
    
    local ListLayout = Instance.new("UIListLayout", UpdateList)
    ListLayout.Padding = UDim.new(0, 8)
    ListLayout.SortOrder = Enum.SortOrder.LayoutOrder
    
    local ListPadding = Instance.new("UIPadding", UpdateList)
    ListPadding.PaddingTop = UDim.new(0, 10)
    ListPadding.PaddingBottom = UDim.new(0, 10)
    ListPadding.PaddingLeft = UDim.new(0, 10)
    ListPadding.PaddingRight = UDim.new(0, 10)
    
    -- Add update logs
    for i, log in ipairs(UPDATE_LOGS) do
        local LogFrame = Instance.new("Frame", UpdateList)
        LogFrame.Size = UDim2.new(1, 0, 0, 30)
        LogFrame.BackgroundColor3 = Color3.fromRGB(45, 45, 55)
        LogFrame.BorderSizePixel = 0
        LogFrame.LayoutOrder = i
        
        local LogCorner = Instance.new("UICorner", LogFrame)
        LogCorner.CornerRadius = UDim.new(0, 6)
        
        local LogText = Instance.new("TextLabel", LogFrame)
        LogText.Size = UDim2.new(1, -20, 1, 0)
        LogText.Position = UDim2.new(0, 10, 0, 0)
        LogText.BackgroundTransparency = 1
        LogText.Text = log
        LogText.TextColor3 = Color3.new(1, 1, 1)
        LogText.Font = Enum.Font.Gotham
        LogText.TextSize = 12
        LogText.TextXAlignment = Enum.TextXAlignment.Left
    end
    
    UpdateList.CanvasSize = UDim2.new(0, 0, 0, ListLayout.AbsoluteContentSize.Y + 20)
    
    local ContinueBtn = Instance.new("TextButton", UpdateFrame)
    ContinueBtn.Size = UDim2.new(0, 120, 0, 35)
    ContinueBtn.Position = UDim2.new(0.5, -60, 1, -50)
    ContinueBtn.BackgroundColor3 = Color3.fromRGB(34, 197, 94)
    ContinueBtn.Text = "CONTINUE"
    ContinueBtn.TextColor3 = Color3.new(1, 1, 1)
    ContinueBtn.Font = Enum.Font.GothamBold
    ContinueBtn.TextSize = 12
    ContinueBtn.AutoButtonColor = false
    
    local ContinueCorner = Instance.new("UICorner", ContinueBtn)
    ContinueCorner.CornerRadius = UDim.new(0, 6)
    
    local function closeUpdate()
        saveCurrentVersion()
        UpdateGui:Destroy()
    end
    
    CloseBtn.MouseButton1Click:Connect(closeUpdate)
    ContinueBtn.MouseButton1Click:Connect(closeUpdate)
    
    task.delay(10, closeUpdate)
end

-- // MAIN SCRIPT FUNCTION //
function StartMainScript()
    if isNewUpdate() then
        ShowUpdateNotification()
        wait(0.5)
    end
    
    local LoadingGui = Instance.new("ScreenGui")
    LoadingGui.Name = "LoadingScreen"
    LoadingGui.ResetOnSpawn = false
    LoadingGui.IgnoreGuiInset = true
    if gethui then LoadingGui.Parent = gethui() else LoadingGui.Parent = CoreGui end

    local LoadingBg = Instance.new("Frame", LoadingGui)
    LoadingBg.Size = UDim2.new(1, 0, 1, 0)
    LoadingBg.BackgroundColor3 = Color3.fromRGB(10, 10, 15)
    LoadingBg.BorderSizePixel = 0

    local LoadingFrame = Instance.new("Frame", LoadingGui)
    LoadingFrame.Size = UDim2.new(0, 350, 0, 180)
    LoadingFrame.Position = UDim2.new(0.5, -175, 0.5, -90)
    LoadingFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
    LoadingFrame.BorderSizePixel = 0

    local LoadingCorner = Instance.new("UICorner", LoadingFrame)
    LoadingCorner.CornerRadius = UDim.new(0, 12)

    local LoadingStroke = Instance.new("UIStroke", LoadingFrame)
    LoadingStroke.Color = Color3.fromRGB(147, 51, 234)
    LoadingStroke.Thickness = 2

    local LoadingTitle = Instance.new("TextLabel", LoadingFrame)
    LoadingTitle.Size = UDim2.new(1, 0, 0, 40)
    LoadingTitle.Position = UDim2.new(0, 0, 0, 20)
    LoadingTitle.BackgroundTransparency = 1
    LoadingTitle.Text = "LENNY HUB v" .. SCRIPT_VERSION
    LoadingTitle.TextColor3 = Color3.fromRGB(147, 51, 234)
    LoadingTitle.Font = Enum.Font.GothamBlack
    LoadingTitle.TextSize = 20

    local LoadingStatus = Instance.new("TextLabel", LoadingFrame)
    LoadingStatus.Size = UDim2.new(1, -40, 0, 20)
    LoadingStatus.Position = UDim2.new(0, 20, 0, 70)
    LoadingStatus.BackgroundTransparency = 1
    LoadingStatus.Text = "Initializing..."
    LoadingStatus.TextColor3 = Color3.fromRGB(200, 200, 200)
    LoadingStatus.Font = Enum.Font.Gotham
    LoadingStatus.TextSize = 12

    local LoadingBar = Instance.new("Frame", LoadingFrame)
    LoadingBar.Size = UDim2.new(0.85, 0, 0, 6)
    LoadingBar.Position = UDim2.new(0.075, 0, 0, 105)
    LoadingBar.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
    LoadingBar.BorderSizePixel = 0

    local LoadingBarCorner = Instance.new("UICorner", LoadingBar)
    LoadingBarCorner.CornerRadius = UDim.new(1, 0)

    local LoadingProgress = Instance.new("Frame", LoadingBar)
    LoadingProgress.Size = UDim2.new(0, 0, 1, 0)
    LoadingProgress.BackgroundColor3 = Color3.fromRGB(147, 51, 234)
    LoadingProgress.BorderSizePixel = 0

    local LoadingProgressCorner = Instance.new("UICorner", LoadingProgress)
    LoadingProgressCorner.CornerRadius = UDim.new(1, 0)

    local loadingSteps = {
        {text = "Initializing...", progress = 0.1},
        {text = "Loading UI components...", progress = 0.25},
        {text = "Setting up aim system...", progress = 0.4},
        {text = "Configuring enhanced ESP...", progress = 0.55},
        {text = "Loading customization options...", progress = 0.7},
        {text = "Loading saved config...", progress = 0.85},
        {text = "Complete!", progress = 1}
    }

    local DefaultConfig = {
        AimEnabled = false,
        TeamCheck = false,
        ESPEnabled = false,
        BoxESPEnabled = false,
        HighlightEnabled = false,
        WallCheck = false,
        ShowFOV = false,
        ShowCrosshair = false,
        ShowNames = true,
        ShowDistance = true,
        ShowHealthBar = true,
        ShowTracers = false,
        LegitMode = false,
        LegitRange = 200,
        FOV = 120,
        Smoothness = 0.25,
        MaxDistance = 500,
        Prediction = 0.1,
        AimPart = "Head",
        CrosshairSize = 14,
        ESPBoxSize = 4,
        NameSpacing = 15,
        
        FOVColor = {147, 51, 234},
        CrosshairColor = {147, 51, 234},
        ESPColor = {255, 0, 255},
        BoxColor = {255, 255, 255},
        HighlightColor = {0, 0, 0},
        NameColor = {255, 255, 255},
        HealthBarColor = {0, 255, 0},
        
        RainbowFOV = false,
        RainbowCrosshair = false,
        RainbowESP = false,
        RainbowHighlight = false,
        RainbowNames = false,
        RainbowBox = false,
    }

    local Config = {}
    for k, v in pairs(DefaultConfig) do
        if type(v) == "table" then
            Config[k] = {v[1], v[2], v[3]}
        else
            Config[k] = v
        end
    end

    local function RGBToColor3(rgb)
        return Color3.fromRGB(rgb[1], rgb[2], rgb[3])
    end

    local RandomAimData = {ShotCount = 0, MaxShots = 5, CurrentPart = "Head"}
    local ESPObjects = {}
    local CurrentConfigSlot = 1
    local MaxConfigSlots = 5
    local ConfigFilePrefix = "LennyHub_Config_Slot_"
    local RainbowHue = 0
    local AimTarget = nil

    local function GetConfigFileName()
        return ConfigFilePrefix .. tostring(CurrentConfigSlot) .. ".json"
    end

    local function SaveConfig()
        pcall(function()
            local fileName = GetConfigFileName()
            writefile(fileName, HttpService:JSONEncode(Config))
            StarterGui:SetCore("SendNotification", {
                Title = "LENNY HUB",
                Text = "Config saved to Slot " .. CurrentConfigSlot .. "!",
                Duration = 3
            })
        end)
    end

    local function LoadConfig()
        local success = pcall(function()
            local fileName = GetConfigFileName()
            if isfile and isfile(fileName) then
                local loadedConfig = HttpService:JSONDecode(readfile(fileName))
                for key, value in pairs(loadedConfig) do
                    if Config[key] ~= nil then Config[key] = value end
                end
                StarterGui:SetCore("SendNotification", {
                    Title = "LENNY HUB",
                    Text = "Config loaded from Slot " .. CurrentConfigSlot .. "!",
                    Duration = 3
                })
                return true
            else
                StarterGui:SetCore("SendNotification", {
                    Title = "LENNY HUB",
                    Text = "No config found in Slot " .. CurrentConfigSlot,
                    Duration = 3
                })
            end
        end)
        return success
    end

    local function DeleteConfig()
        pcall(function()
            local fileName = GetConfigFileName()
            if isfile and isfile(fileName) then
                delfile(fileName)
                StarterGui:SetCore("SendNotification", {
                    Title = "LENNY HUB",
                    Text = "Config deleted from Slot " .. CurrentConfigSlot .. "!",
                    Duration = 3
                })
            else
                StarterGui:SetCore("SendNotification", {
                    Title = "LENNY HUB",
                    Text = "No config to delete in Slot " .. CurrentConfigSlot,
                    Duration = 3
                })
            end
        end)
    end

    local function GetSavedSlotsCount()
        local count = 0
        for i = 1, MaxConfigSlots do
            local fileName = ConfigFilePrefix .. tostring(i) .. ".json"
            if isfile and isfile(fileName) then
                count = count + 1
            end
        end
        return count
    end

    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "LennyHub"
    ScreenGui.ResetOnSpawn = false
    ScreenGui.IgnoreGuiInset = true
    if gethui then ScreenGui.Parent = gethui() else ScreenGui.Parent = CoreGui end

    local MainFrame = Instance.new("Frame", ScreenGui)
    MainFrame.Size = UDim2.new(0, 420, 0, 580)
    MainFrame.Position = UDim2.new(0.5, -210, 0.5, -290)
    MainFrame.BackgroundColor3 = Color3.fromRGB(18, 18, 23)
    MainFrame.BorderSizePixel = 0
    MainFrame.Active = true
    MainFrame.Draggable = true
    MainFrame.Visible = false
    MainFrame.ClipsDescendants = true

    local MainCorner = Instance.new("UICorner", MainFrame)
    MainCorner.CornerRadius = UDim.new(0, 12)

    local MainStroke = Instance.new("UIStroke", MainFrame)
    MainStroke.Color = Color3.fromRGB(147, 51, 234)
    MainStroke.Thickness = 2

    local TopBar = Instance.new("Frame", MainFrame)
    TopBar.Size = UDim2.new(1, 0, 0, 45)
    TopBar.BackgroundColor3 = Color3.fromRGB(28, 28, 35)
    TopBar.BorderSizePixel = 0

    local TopBarCorner = Instance.new("UICorner", TopBar)
    TopBarCorner.CornerRadius = UDim.new(0, 12)

    local TopBarCover = Instance.new("Frame", TopBar)
    TopBarCover.Size = UDim2.new(1, 0, 0, 12)
    TopBarCover.Position = UDim2.new(0, 0, 1, -12)
    TopBarCover.BackgroundColor3 = Color3.fromRGB(28, 28, 35)
    TopBarCover.BorderSizePixel = 0

    local Title = Instance.new("TextLabel", TopBar)
    Title.Size = UDim2.new(1, -160, 1, 0)
    Title.Position = UDim2.new(0, 15, 0, 0)
    Title.BackgroundTransparency = 1
    Title.Text = "LENNY HUB v" .. SCRIPT_VERSION
    Title.TextColor3 = Color3.fromRGB(147, 51, 234)
    Title.Font = Enum.Font.GothamBlack
    Title.TextSize = 16
    Title.TextXAlignment = Enum.TextXAlignment.Left

    local SettingsBtn = Instance.new("TextButton", TopBar)
    SettingsBtn.Size = UDim2.new(0, 30, 0, 30)
    SettingsBtn.Position = UDim2.new(1, -140, 0.5, -15)
    SettingsBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 110)
    SettingsBtn.Text = "âš™"
    SettingsBtn.TextColor3 = Color3.new(1, 1, 1)
    SettingsBtn.Font = Enum.Font.GothamBold
    SettingsBtn.TextSize = 16
    SettingsBtn.AutoButtonColor = false

    local SettingsCorner = Instance.new("UICorner", SettingsBtn)
    SettingsCorner.CornerRadius = UDim.new(0, 6)

    local SuggestBtn = Instance.new("TextButton", TopBar)
    SuggestBtn.Size = UDim2.new(0, 30, 0, 30)
    SuggestBtn.Position = UDim2.new(1, -100, 0.5, -15)
    SuggestBtn.BackgroundColor3 = Color3.fromRGB(59, 130, 246)
    SuggestBtn.Text = "?"
    SuggestBtn.TextColor3 = Color3.new(1, 1, 1)
    SuggestBtn.Font = Enum.Font.GothamBold
    SuggestBtn.TextSize = 16
    SuggestBtn.AutoButtonColor = false

    local SuggestCorner = Instance.new("UICorner", SuggestBtn)
    SuggestCorner.CornerRadius = UDim.new(0, 6)

    local MinimizeBtn = Instance.new("TextButton", TopBar)
    MinimizeBtn.Size = UDim2.new(0, 30, 0, 30)
    MinimizeBtn.Position = UDim2.new(1, -60, 0.5, -15)
    MinimizeBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 110)
    MinimizeBtn.Text = "âˆ’"
    MinimizeBtn.TextColor3 = Color3.new(1, 1, 1)
    MinimizeBtn.Font = Enum.Font.GothamBlack
    MinimizeBtn.TextSize = 18
    MinimizeBtn.AutoButtonColor = false

    local MinimizeCorner = Instance.new("UICorner", MinimizeBtn)
    MinimizeCorner.CornerRadius = UDim.new(0, 6)

    local CloseBtn = Instance.new("TextButton", TopBar)
    CloseBtn.Size = UDim2.new(0, 30, 0, 30)
    CloseBtn.Position = UDim2.new(1, -25, 0.5, -15)
    CloseBtn.BackgroundColor3 = Color3.fromRGB(239, 68, 68)
    CloseBtn.Text = "Ã—"
    CloseBtn.TextColor3 = Color3.new(1, 1, 1)
    CloseBtn.Font = Enum.Font.GothamBlack
    CloseBtn.TextSize = 20
    CloseBtn.AutoButtonColor = false

    local CloseCorner = Instance.new("UICorner", CloseBtn)
    CloseCorner.CornerRadius = UDim.new(0, 6)

    local RestoreBtn = Instance.new("TextButton", ScreenGui)
    RestoreBtn.Size = UDim2.new(0, 55, 0, 55)
    RestoreBtn.Position = UDim2.new(0, 20, 0.5, -27.5)
    RestoreBtn.BackgroundColor3 = Color3.fromRGB(147, 51, 234)
    RestoreBtn.Text = "L"
    RestoreBtn.TextColor3 = Color3.new(1, 1, 1)
    RestoreBtn.Font = Enum.Font.GothamBlack
    RestoreBtn.TextSize = 28
    RestoreBtn.Visible = false
    RestoreBtn.AutoButtonColor = false
    RestoreBtn.ZIndex = 500

    local RestoreCorner = Instance.new("UICorner", RestoreBtn)
    RestoreCorner.CornerRadius = UDim.new(1, 0)

    local RestoreStroke = Instance.new("UIStroke", RestoreBtn)
    RestoreStroke.Color = Color3.fromRGB(147, 51, 234)
    RestoreStroke.Thickness = 3

    local SuggestPanel = Instance.new("Frame", ScreenGui)
    SuggestPanel.Size = UDim2.new(0, 340, 0, 280)
    SuggestPanel.Position = UDim2.new(0.5, -170, 0.5, -140)
    SuggestPanel.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
    SuggestPanel.BorderSizePixel = 0
    SuggestPanel.Visible = false
    SuggestPanel.ZIndex = 600

    local SuggestCorner = Instance.new("UICorner", SuggestPanel)
    SuggestCorner.CornerRadius = UDim.new(0, 12)

    local SuggestStroke = Instance.new("UIStroke", SuggestPanel)
    SuggestStroke.Color = Color3.fromRGB(59, 130, 246)
    SuggestStroke.Thickness = 2

    local SuggestTitle = Instance.new("TextLabel", SuggestPanel)
    SuggestTitle.Size = UDim2.new(1, -40, 0, 35)
    SuggestTitle.Position = UDim2.new(0, 15, 0, 10)
    SuggestTitle.BackgroundTransparency = 1
    SuggestTitle.Text = "PRO TIPS & FEATURES"
    SuggestTitle.TextColor3 = Color3.fromRGB(59, 130, 246)
    SuggestTitle.Font = Enum.Font.GothamBold
    SuggestTitle.TextSize = 16
    SuggestTitle.TextXAlignment = Enum.TextXAlignment.Left
    SuggestTitle.ZIndex = 601

    local SuggestClose = Instance.new("TextButton", SuggestPanel)
    SuggestClose.Size = UDim2.new(0, 25, 0, 25)
    SuggestClose.Position = UDim2.new(1, -30, 0, 10)
    SuggestClose.BackgroundColor3 = Color3.fromRGB(239, 68, 68)
    SuggestClose.Text = "Ã—"
    SuggestClose.TextColor3 = Color3.new(1, 1, 1)
    SuggestClose.Font = Enum.Font.GothamBold
    SuggestClose.TextSize = 16
    SuggestClose.AutoButtonColor = false
    SuggestClose.ZIndex = 601

    local SuggestCloseCorner = Instance.new("UICorner", SuggestClose)
    SuggestCloseCorner.CornerRadius = UDim.new(0, 5)

    local tips = {
        "â€¢ Lower smoothness = More legit aim",
        "â€¢ Use 100-150 FOV for best results",
        "â€¢ Enable Wall Check to avoid targeting through walls",
        "â€¢ Random aim part helps avoid detection",
        "â€¢ Legit Mode activates only at long range",
        "â€¢ 2D Box ESP shows full body coverage",
        "â€¢ Enhanced ESP shows names, distance, and health",
        "â€¢ Customize name spacing for better visibility",
        "â€¢ Save your config after tweaking!",
        "â€¢ Use multiple config slots for different games"
    }

    local SuggestText = Instance.new("TextLabel", SuggestPanel)
    SuggestText.Size = UDim2.new(1, -30, 1, -55)
    SuggestText.Position = UDim2.new(0, 15, 0, 45)
    SuggestText.BackgroundTransparency = 1
    SuggestText.Text = table.concat(tips, "\n")
    SuggestText.TextColor3 = Color3.fromRGB(200, 200, 200)
    SuggestText.Font = Enum.Font.Gotham
    SuggestText.TextSize = 11
    SuggestText.TextXAlignment = Enum.TextXAlignment.Left
    SuggestText.TextYAlignment = Enum.TextYAlignment.Top
    SuggestText.TextWrapped = true
    SuggestText.ZIndex = 601

    local Content = Instance.new("ScrollingFrame", MainFrame)
    Content.Size = UDim2.new(1, -20, 1, -55)
    Content.Position = UDim2.new(0, 10, 0, 50)
    Content.BackgroundTransparency = 1
    Content.BorderSizePixel = 0
    Content.ScrollBarThickness = 4
    Content.ScrollBarImageColor3 = Color3.fromRGB(147, 51, 234)
    Content.CanvasSize = UDim2.new(0, 0, 0, 0)
    Content.AutomaticCanvasSize = Enum.AutomaticSize.Y

    local ContentLayout = Instance.new("UIListLayout", Content)
    ContentLayout.Padding = UDim.new(0, 10)
    ContentLayout.SortOrder = Enum.SortOrder.LayoutOrder

    -- FOV Circle (Fixed positioning)
    local FOVCircle = Instance.new("Frame", ScreenGui)
    FOVCircle.Size = UDim2.new(0, Config.FOV, 0, Config.FOV)
    FOVCircle.BackgroundTransparency = 1
    FOVCircle.Visible = false
    FOVCircle.ZIndex = 10
    FOVCircle.AnchorPoint = Vector2.new(0.5, 0.5)

    local FOVStroke = Instance.new("UIStroke", FOVCircle)
    FOVStroke.Color = RGBToColor3(Config.FOVColor)
    FOVStroke.Thickness = 2
    FOVStroke.Transparency = 0.3

    local FOVCorner = Instance.new("UICorner", FOVCircle)
    FOVCorner.CornerRadius = UDim.new(1, 0)

    local Crosshair = Instance.new("Frame", ScreenGui)
    Crosshair.Size = UDim2.new(0, 4, 0, 4)
    Crosshair.BackgroundColor3 = RGBToColor3(Config.CrosshairColor)
    Crosshair.BorderSizePixel = 0
    Crosshair.Visible = false
    Crosshair.ZIndex = 11
    Crosshair.AnchorPoint = Vector2.new(0.5, 0.5)

    local CrosshairCorner = Instance.new("UICorner", Crosshair)
    CrosshairCorner.CornerRadius = UDim.new(1, 0)

    local HorizontalLine = Instance.new("Frame", ScreenGui)
    HorizontalLine.Size = UDim2.new(0, Config.CrosshairSize, 0, 2)
    HorizontalLine.BackgroundColor3 = RGBToColor3(Config.CrosshairColor)
    HorizontalLine.BorderSizePixel = 0
    HorizontalLine.BackgroundTransparency = 0.3
    HorizontalLine.Visible = false
    HorizontalLine.ZIndex = 11
    HorizontalLine.AnchorPoint = Vector2.new(0.5, 0.5)

    local VerticalLine = Instance.new("Frame", ScreenGui)
    VerticalLine.Size = UDim2.new(0, 2, 0, Config.CrosshairSize)
    VerticalLine.BackgroundColor3 = RGBToColor3(Config.CrosshairColor)
    VerticalLine.BorderSizePixel = 0
    VerticalLine.BackgroundTransparency = 0.3
    VerticalLine.Visible = false
    VerticalLine.ZIndex = 11
    VerticalLine.AnchorPoint = Vector2.new(0.5, 0.5)

    local function UpdateFOVPosition()
        local viewportSize = Camera.ViewportSize
        local centerX = viewportSize.X / 2
        local centerY = viewportSize.Y / 2
        
        FOVCircle.Position = UDim2.new(0, centerX, 0, centerY)
        Crosshair.Position = UDim2.new(0, centerX, 0, centerY)
        HorizontalLine.Position = UDim2.new(0, centerX, 0, centerY)
        VerticalLine.Position = UDim2.new(0, centerX, 0, centerY)
    end

    -- SINGLE TARGET HIGHLIGHT
    local TargetHighlight = Instance.new("Highlight", CoreGui)
    TargetHighlight.FillColor = RGBToColor3(Config.HighlightColor)
    TargetHighlight.OutlineColor = Color3.fromRGB(255, 255, 255)
    TargetHighlight.FillTransparency = 0.5
    TargetHighlight.OutlineTransparency = 0
    TargetHighlight.Enabled = false

    -- Enhanced ESP Objects with 2D Box
    local function CreateESP(player)
        if ESPObjects[player] then return end
        
        local espObjects = {}
        
        -- Main Highlight
        local highlight = Instance.new("Highlight")
        highlight.Name = "ESP_" .. player.Name
        highlight.FillColor = RGBToColor3(Config.ESPColor)
        highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
        highlight.FillTransparency = 0.4
        highlight.OutlineTransparency = 0
        highlight.Enabled = false
        highlight.Parent = CoreGui
        
        -- 2D Box ESP
        local boxTop = Instance.new("Frame")
        boxTop.Name = "BoxTop_" .. player.Name
        boxTop.BackgroundColor3 = RGBToColor3(Config.BoxColor)
        boxTop.BorderSizePixel = 0
        boxTop.Visible = false
        boxTop.Parent = CoreGui
        
        local boxBottom = Instance.new("Frame")
        boxBottom.Name = "BoxBottom_" .. player.Name
        boxBottom.BackgroundColor3 = RGBToColor3(Config.BoxColor)
        boxBottom.BorderSizePixel = 0
        boxBottom.Visible = false
        boxBottom.Parent = CoreGui
        
        local boxLeft = Instance.new("Frame")
        boxLeft.Name = "BoxLeft_" .. player.Name
        boxLeft.BackgroundColor3 = RGBToColor3(Config.BoxColor)
        boxLeft.BorderSizePixel = 0
        boxLeft.Visible = false
        boxLeft.Parent = CoreGui
        
        local boxRight = Instance.new("Frame")
        boxRight.Name = "BoxRight_" .. player.Name
        boxRight.BackgroundColor3 = RGBToColor3(Config.BoxColor)
        boxRight.BorderSizePixel = 0
        boxRight.Visible = false
        boxRight.Parent = CoreGui
        
        -- Name Label
        local nameLabel = Instance.new("TextLabel")
        nameLabel.Name = "ESPName_" .. player.Name
        nameLabel.BackgroundTransparency = 1
        nameLabel.BorderSizePixel = 0
        nameLabel.Text = player.Name
        nameLabel.TextColor3 = RGBToColor3(Config.NameColor)
        nameLabel.Font = Enum.Font.GothamBold
        nameLabel.TextSize = 12
        nameLabel.Visible = false
        nameLabel.Parent = CoreGui
        
        -- Distance Label
        local distanceLabel = Instance.new("TextLabel")
        distanceLabel.Name = "ESPDist_" .. player.Name
        distanceLabel.BackgroundTransparency = 1
        distanceLabel.BorderSizePixel = 0
        distanceLabel.Text = ""
        distanceLabel.TextColor3 = RGBToColor3(Config.NameColor)
        distanceLabel.Font = Enum.Font.Gotham
        distanceLabel.TextSize = 10
        distanceLabel.Visible = false
        distanceLabel.Parent = CoreGui
        
        -- Health Bar Background
        local healthBg = Instance.new("Frame")
        healthBg.Name = "ESPHealthBg_" .. player.Name
        healthBg.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
        healthBg.BorderSizePixel = 0
        healthBg.Visible = false
        healthBg.Parent = CoreGui
        
        local healthBgCorner = Instance.new("UICorner", healthBg)
        healthBgCorner.CornerRadius = UDim.new(0, 2)
        
        -- Health Bar
        local healthBar = Instance.new("Frame")
        healthBar.Name = "ESPHealth_" .. player.Name
        healthBar.BackgroundColor3 = RGBToColor3(Config.HealthBarColor)
        healthBar.BorderSizePixel = 0
        healthBar.Visible = false
        healthBar.Parent = CoreGui
        
        local healthBarCorner = Instance.new("UICorner", healthBar)
        healthBarCorner.CornerRadius = UDim.new(0, 2)
        
        -- Tracer Line
        local tracer = Instance.new("Frame")
        tracer.Name = "ESPTracer_" .. player.Name
        tracer.BackgroundColor3 = RGBToColor3(Config.ESPColor)
        tracer.BorderSizePixel = 0
        tracer.Visible = false
        tracer.Parent = CoreGui
        
        espObjects.Highlight = highlight
        espObjects.BoxTop = boxTop
        espObjects.BoxBottom = boxBottom
        espObjects.BoxLeft = boxLeft
        espObjects.BoxRight = boxRight
        espObjects.NameLabel = nameLabel
        espObjects.DistanceLabel = distanceLabel
        espObjects.HealthBg = healthBg
        espObjects.HealthBar = healthBar
        espObjects.Tracer = tracer
        
        ESPObjects[player] = espObjects
    end

    local function RemoveESP(player)
        if ESPObjects[player] then
            for _, obj in pairs(ESPObjects[player]) do
                if obj and obj.Destroy then
                    obj:Destroy()
                end
            end
            ESPObjects[player] = nil
        end
    end

    local function UpdateESP()
        for player, esp in pairs(ESPObjects) do
            if not player or not player.Parent or not player.Character then
                for _, obj in pairs(esp) do
                    if obj.Visible ~= nil then obj.Visible = false end
                end
                continue
            end
            
            local character = player.Character
            local humanoid = character:FindFirstChild("Humanoid")
            
            if not humanoid or humanoid.Health <= 0 then
                for _, obj in pairs(esp) do
                    if obj.Visible ~= nil then obj.Visible = false end
                end
                continue
            end
            
            if Config.TeamCheck and player.Team == LocalPlayer.Team then
                for _, obj in pairs(esp) do
                    if obj.Visible ~= nil then obj.Visible = false end
                end
                continue
            end
            
            if Config.ESPEnabled or Config.BoxESPEnabled then
                local head = character:FindFirstChild("Head")
                local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
                
                if head and humanoidRootPart then
                    local headPos, onScreen = Camera:WorldToViewportPoint(head.Position)
                    local rootPos, rootOnScreen = Camera:WorldToViewportPoint(humanoidRootPart.Position)
                    local distance = (LocalPlayer.Character.HumanoidRootPart.Position - humanoidRootPart.Position).Magnitude
                    
                    if onScreen then
                        -- Update Highlight
                        if Config.ESPEnabled then
                            esp.Highlight.Adornee = character
                            esp.Highlight.FillColor = RGBToColor3(Config.ESPColor)
                            esp.Highlight.Enabled = true
                        else
                            esp.Highlight.Enabled = false
                        end
                        
                        -- Update 2D Box ESP
                        if Config.BoxESPEnabled then
                            local boxColor = Config.RainbowBox and Color3.fromHSV(RainbowHue / 360, 1, 1) or RGBToColor3(Config.BoxColor)
                            local boxThickness = 2
                            local padding = 10
                            
                            -- Calculate box dimensions
                            local topY = headPos.Y - padding
                            local bottomY = rootPos.Y + padding
                            local boxHeight = bottomY - topY
                            local boxWidth = boxHeight * 0.6
                            local centerX = headPos.X
                            local leftX = centerX - boxWidth / 2
                            local rightX = centerX + boxWidth / 2
                            
                            -- Update box parts
                            esp.BoxTop.Size = UDim2.new(0, boxWidth, 0, boxThickness)
                            esp.BoxTop.Position = UDim2.new(0, leftX, 0, topY)
                            esp.BoxTop.BackgroundColor3 = boxColor
                            esp.BoxTop.Visible = true
                            
                            esp.BoxBottom.Size = UDim2.new(0, boxWidth, 0, boxThickness)
                            esp.BoxBottom.Position = UDim2.new(0, leftX, 0, bottomY)
                            esp.BoxBottom.BackgroundColor3 = boxColor
                            esp.BoxBottom.Visible = true
                            
                            esp.BoxLeft.Size = UDim2.new(0, boxThickness, 0, boxHeight)
                            esp.BoxLeft.Position = UDim2.new(0, leftX, 0, topY)
                            esp.BoxLeft.BackgroundColor3 = boxColor
                            esp.BoxLeft.Visible = true
                            
                            esp.BoxRight.Size = UDim2.new(0, boxThickness, 0, boxHeight)
                            esp.BoxRight.Position = UDim2.new(0, rightX, 0, topY)
                            esp.BoxRight.BackgroundColor3 = boxColor
                            esp.BoxRight.Visible = true
                        else
                            esp.BoxTop.Visible = false
                            esp.BoxBottom.Visible = false
                            esp.BoxLeft.Visible = false
                            esp.BoxRight.Visible = false
                        end
                        
                        -- Update Name Label
                        if Config.ShowNames then
                            esp.NameLabel.Text = player.Name
                            esp.NameLabel.Position = UDim2.new(0, headPos.X - 30, 0, headPos.Y - Config.NameSpacing)
                            esp.NameLabel.TextColor3 = Config.RainbowNames and Color3.fromHSV(RainbowHue / 360, 1, 1) or RGBToColor3(Config.NameColor)
                            esp.NameLabel.Visible = true
                        else
                            esp.NameLabel.Visible = false
                        end
                        
                        -- Update Distance Label
                        if Config.ShowDistance then
                            esp.DistanceLabel.Text = math.floor(distance) .. " studs"
                            esp.DistanceLabel.Position = UDim2.new(0, headPos.X - 30, 0, headPos.Y - Config.NameSpacing + 12)
                            esp.DistanceLabel.TextColor3 = Config.RainbowNames and Color3.fromHSV(RainbowHue / 360, 1, 1) or RGBToColor3(Config.NameColor)
                            esp.DistanceLabel.Visible = true
                        else
                            esp.DistanceLabel.Visible = false
                        end
                        
                        -- Update Health Bar
                        if Config.ShowHealthBar then
                            local healthPercent = humanoid.Health / humanoid.MaxHealth
                            esp.HealthBg.Size = UDim2.new(0, 40, 0, 4)
                            esp.HealthBg.Position = UDim2.new(0, headPos.X - 20, 0, headPos.Y - Config.NameSpacing + 24)
                            esp.HealthBg.Visible = true
                            
                            esp.HealthBar.Size = UDim2.new(healthPercent, 0, 1, 0)
                            esp.HealthBar.Position = UDim2.new(0, headPos.X - 20, 0, headPos.Y - Config.NameSpacing + 24)
                            esp.HealthBar.Visible = true
                            
                            -- Change color based on health
                            if healthPercent > 0.6 then
                                esp.HealthBar.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
                            elseif healthPercent > 0.3 then
                                esp.HealthBar.BackgroundColor3 = Color3.fromRGB(255, 255, 0)
                            else
                                esp.HealthBar.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
                            end
                        else
                            esp.HealthBg.Visible = false
                            esp.HealthBar.Visible = false
                        end
                        
                        -- Update Tracer
                        if Config.ShowTracers then
                            local viewportSize = Camera.ViewportSize
                            local screenCenter = Vector2.new(viewportSize.X / 2, viewportSize.Y)
                            
                            esp.Tracer.Size = UDim2.new(0, 2, 0, math.abs(screenCenter.Y - headPos.Y))
                            esp.Tracer.Position = UDim2.new(0, headPos.X - 1, 0, math.min(headPos.Y, screenCenter.Y))
                            esp.Tracer.BackgroundColor3 = RGBToColor3(Config.ESPColor)
                            esp.Tracer.Visible = true
                        else
                            esp.Tracer.Visible = false
                        end
                    else
                        for _, obj in pairs(esp) do
                            if obj.Visible ~= nil then obj.Visible = false end
                        end
                    end
                else
                    for _, obj in pairs(esp) do
                        if obj.Visible ~= nil then obj.Visible = false end
                    end
                end
            else
                for _, obj in pairs(esp) do
                    if obj.Visible ~= nil then obj.Visible = false end
                end
            end
        end
    end

    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then 
            CreateESP(player)
        end
    end

    Players.PlayerAdded:Connect(CreateESP)
    Players.PlayerRemoving:Connect(RemoveESP)

    local function Animate(obj, property, value)
        TweenService:Create(obj, TweenInfo.new(0.2, Enum.EasingStyle.Quad), {[property] = value}):Play()
    end

    SuggestBtn.MouseButton1Click:Connect(function()
        SuggestPanel.Visible = not SuggestPanel.Visible
    end)

    SuggestClose.MouseButton1Click:Connect(function()
        SuggestPanel.Visible = false
    end)

    CloseBtn.MouseButton1Click:Connect(function()
        Config.AimEnabled = false
        Config.ESPEnabled = false
        Config.BoxESPEnabled = false
        Config.HighlightEnabled = false
        TargetHighlight.Enabled = false
        for _, esp in pairs(ESPObjects) do 
            for _, obj in pairs(esp) do
                if obj.Destroy then obj:Destroy() end
            end
        end
        ScreenGui:Destroy()
        StarterGui:SetCore("SendNotification", {
            Title = "LENNY HUB",
            Text = "Thank you for using our service!",
            Duration = 5
        })
    end)

    MinimizeBtn.MouseButton1Click:Connect(function()
        MainFrame.Visible = false
        RestoreBtn.Visible = true
    end)

    RestoreBtn.MouseButton1Click:Connect(function()
        MainFrame.Visible = true
        RestoreBtn.Visible = false
    end)

    CloseBtn.MouseEnter:Connect(function() Animate(CloseBtn, "BackgroundColor3", Color3.fromRGB(220, 50, 50)) end)
    CloseBtn.MouseLeave:Connect(function() Animate(CloseBtn, "BackgroundColor3", Color3.fromRGB(239, 68, 68)) end)

    -- UI COMPONENTS
    local function CreateSection(title)
        local section = Instance.new("Frame", Content)
        section.Size = UDim2.new(1, 0, 0, 0)
        section.BackgroundColor3 = Color3.fromRGB(28, 28, 35)
        section.BorderSizePixel = 0
        section.AutomaticSize = Enum.AutomaticSize.Y
        section.LayoutOrder = #Content:GetChildren()
        
        local sectionCorner = Instance.new("UICorner", section)
        sectionCorner.CornerRadius = UDim.new(0, 10)
        
        local sectionTitle = Instance.new("TextLabel", section)
        sectionTitle.Size = UDim2.new(1, -20, 0, 30)
        sectionTitle.Position = UDim2.new(0, 12, 0, 0)
        sectionTitle.BackgroundTransparency = 1
        sectionTitle.Text = title
        sectionTitle.TextColor3 = Color3.fromRGB(147, 51, 234)
        sectionTitle.Font = Enum.Font.GothamBold
        sectionTitle.TextSize = 14
        sectionTitle.TextXAlignment = Enum.TextXAlignment.Left
        
        local divider = Instance.new("Frame", section)
        divider.Size = UDim2.new(1, -24, 0, 1)
        divider.Position = UDim2.new(0, 12, 0, 30)
        divider.BackgroundColor3 = Color3.fromRGB(147, 51, 234)
        divider.BorderSizePixel = 0
        divider.BackgroundTransparency = 0.6
        
        local layout = Instance.new("UIListLayout", section)
        layout.Padding = UDim.new(0, 8)
        layout.SortOrder = Enum.SortOrder.LayoutOrder
        
        local padding = Instance.new("UIPadding", section)
        padding.PaddingTop = UDim.new(0, 36)
        padding.PaddingBottom = UDim.new(0, 10)
        padding.PaddingLeft = UDim.new(0, 12)
        padding.PaddingRight = UDim.new(0, 12)
        
        return section
    end

    local function CreateToggle(parent, text, settingName)
        local toggle = Instance.new("Frame", parent)
        toggle.Size = UDim2.new(1, 0, 0, 35)
        toggle.BackgroundColor3 = Color3.fromRGB(38, 38, 46)
        toggle.BorderSizePixel = 0
        toggle.LayoutOrder = #parent:GetChildren()
        
        local toggleCorner = Instance.new("UICorner", toggle)
        toggleCorner.CornerRadius = UDim.new(0, 8)
        
        local label = Instance.new("TextLabel", toggle)
        label.Size = UDim2.new(1, -55, 1, 0)
        label.Position = UDim2.new(0, 12, 0, 0)
        label.BackgroundTransparency = 1
        label.Text = text
        label.TextColor3 = Color3.new(1, 1, 1)
        label.Font = Enum.Font.Gotham
        label.TextSize = 12
        label.TextXAlignment = Enum.TextXAlignment.Left
        
        local switchBg = Instance.new("Frame", toggle)
        switchBg.Size = UDim2.new(0, 44, 0, 24)
        switchBg.Position = UDim2.new(1, -50, 0.5, -12)
        switchBg.BackgroundColor3 = Config[settingName] and Color3.fromRGB(147, 51, 234) or Color3.fromRGB(70, 70, 80)
        switchBg.BorderSizePixel = 0
        
        local switchCorner = Instance.new("UICorner", switchBg)
        switchCorner.CornerRadius = UDim.new(1, 0)
        
        local switchKnob = Instance.new("Frame", switchBg)
        switchKnob.Size = UDim2.new(0, 18, 0, 18)
        switchKnob.Position = Config[settingName] and UDim2.new(1, -21, 0.5, -9) or UDim2.new(0, 3, 0.5, -9)
        switchKnob.BackgroundColor3 = Color3.new(1, 1, 1)
        switchKnob.BorderSizePixel = 0
        
        local knobCorner = Instance.new("UICorner", switchKnob)
        knobCorner.CornerRadius = UDim.new(1, 0)
        
        local button = Instance.new("TextButton", toggle)
        button.Size = UDim2.new(1, 0, 1, 0)
        button.BackgroundTransparency = 1
        button.Text = ""
        
        button.MouseButton1Click:Connect(function()
            Config[settingName] = not Config[settingName]
            Animate(switchBg, "BackgroundColor3", Config[settingName] and Color3.fromRGB(147, 51, 234) or Color3.fromRGB(70, 70, 80))
            Animate(switchKnob, "Position", Config[settingName] and UDim2.new(1, -21, 0.5, -9) or UDim2.new(0, 3, 0.5, -9))
            
            if settingName == "ShowFOV" then FOVCircle.Visible = Config.ShowFOV
            elseif settingName == "ShowCrosshair" then
                Crosshair.Visible = Config.ShowCrosshair
                HorizontalLine.Visible = Config.ShowCrosshair
                VerticalLine.Visible = Config.ShowCrosshair
            end
        end)
        
        return toggle
    end

    local function CreateSlider(parent, text, min, max, settingName, format)
        local slider = Instance.new("Frame", parent)
        slider.Size = UDim2.new(1, 0, 0, 50)
        slider.BackgroundColor3 = Color3.fromRGB(38, 38, 46)
        slider.BorderSizePixel = 0
        slider.LayoutOrder = #parent:GetChildren()
        
        local sliderCorner = Instance.new("UICorner", slider)
        sliderCorner.CornerRadius = UDim.new(0, 8)
        
        local label = Instance.new("TextLabel", slider)
        label.Size = UDim2.new(1, -70, 0, 20)
        label.Position = UDim2.new(0, 12, 0, 6)
        label.BackgroundTransparency = 1
        label.Text = text
        label.TextColor3 = Color3.new(1, 1, 1)
        label.Font = Enum.Font.Gotham
        label.TextSize = 12
        label.TextXAlignment = Enum.TextXAlignment.Left
        
        local value = Instance.new("TextLabel", slider)
        value.Size = UDim2.new(0, 55, 0, 20)
        value.Position = UDim2.new(1, -62, 0, 6)
        value.BackgroundTransparency = 1
        value.Text = format and format(Config[settingName]) or tostring(Config[settingName])
        value.TextColor3 = Color3.fromRGB(147, 51, 234)
        value.Font = Enum.Font.GothamBold
        value.TextSize = 12
        
        local track = Instance.new("Frame", slider)
        track.Size = UDim2.new(1, -24, 0, 4)
        track.Position = UDim2.new(0, 12, 0, 32)
        track.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
        track.BorderSizePixel = 0
        
        local trackCorner = Instance.new("UICorner", track)
        trackCorner.CornerRadius = UDim.new(1, 0)
        
        local fill = Instance.new("Frame", track)
        fill.Size = UDim2.new((Config[settingName] - min) / (max - min), 0, 1, 0)
        fill.BackgroundColor3 = Color3.fromRGB(147, 51, 234)
        fill.BorderSizePixel = 0
        
        local fillCorner = Instance.new("UICorner", fill)
        fillCorner.CornerRadius = UDim.new(1, 0)
        
        local knob = Instance.new("Frame", track)
        knob.Size = UDim2.new(0, 14, 0, 14)
        knob.Position = UDim2.new((Config[settingName] - min) / (max - min), -7, 0.5, -7)
        knob.BackgroundColor3 = Color3.new(1, 1, 1)
        knob.BorderSizePixel = 0
        
        local knobCorner = Instance.new("UICorner", knob)
        knobCorner.CornerRadius = UDim.new(1, 0)
        
        local knobStroke = Instance.new("UIStroke", knob)
        knobStroke.Color = Color3.fromRGB(147, 51, 234)
        knobStroke.Thickness = 2
        
        local function updateValue(val)
            val = math.clamp(val, min, max)
            Config[settingName] = val
            
            local percent = (val - min) / (max - min)
            fill.Size = UDim2.new(percent, 0, 1, 0)
            knob.Position = UDim2.new(percent, -7, 0.5, -7)
            value.Text = format and format(val) or tostring(val)
            
            if settingName == "FOV" then FOVCircle.Size = UDim2.new(0, val, 0, val)
            elseif settingName == "CrosshairSize" then
                HorizontalLine.Size = UDim2.new(0, val, 0, 2)
                VerticalLine.Size = UDim2.new(0, 2, 0, val)
            end
        end
        
        local dragging = false
        
        knob.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                dragging = true
            end
        end)
        
        UserInputService.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                dragging = false
            end
        end)
        
        UserInputService.InputChanged:Connect(function(input)
            if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
                local mousePos = UserInputService:GetMouseLocation().X
                local trackPos = track.AbsolutePosition.X
                local trackSize = track.AbsoluteSize.X
                local percent = math.clamp((mousePos - trackPos) / trackSize, 0, 1)
                updateValue(min + (percent * (max - min)))
            end
        end)
        
        return slider
    end

    local function CreateColorSlider(parent, text, settingName, rainbowSetting)
        local colorFrame = Instance.new("Frame", parent)
        colorFrame.Size = UDim2.new(1, 0, 0, 115)
        colorFrame.BackgroundColor3 = Color3.fromRGB(38, 38, 46)
        colorFrame.BorderSizePixel = 0
        colorFrame.LayoutOrder = #parent:GetChildren()
        
        local colorCorner = Instance.new("UICorner", colorFrame)
        colorCorner.CornerRadius = UDim.new(0, 8)
        
        local label = Instance.new("TextLabel", colorFrame)
        label.Size = UDim2.new(1, -80, 0, 22)
        label.Position = UDim2.new(0, 12, 0, 6)
        label.BackgroundTransparency = 1
        label.Text = text
        label.TextColor3 = Color3.new(1, 1, 1)
        label.Font = Enum.Font.Gotham
        label.TextSize = 12
        label.TextXAlignment = Enum.TextXAlignment.Left
        
        local preview = Instance.new("Frame", colorFrame)
        preview.Size = UDim2.new(0, 45, 0, 22)
        preview.Position = UDim2.new(1, -80, 0, 6)
        preview.BackgroundColor3 = RGBToColor3(Config[settingName])
        preview.BorderSizePixel = 0
        
        local previewCorner = Instance.new("UICorner", preview)
        previewCorner.CornerRadius = UDim.new(0, 6)
        
        local rainbowBtn = Instance.new("TextButton", colorFrame)
        rainbowBtn.Size = UDim2.new(0, 30, 0, 22)
        rainbowBtn.Position = UDim2.new(1, -30, 0, 6)
        rainbowBtn.BackgroundColor3 = Config[rainbowSetting] and Color3.fromRGB(147, 51, 234) or Color3.fromRGB(60, 60, 70)
        rainbowBtn.Text = "RGB"
        rainbowBtn.TextColor3 = Color3.new(1, 1, 1)
        rainbowBtn.Font = Enum.Font.GothamBold
        rainbowBtn.TextSize = 10
        rainbowBtn.AutoButtonColor = false
        
        local rainbowCorner = Instance.new("UICorner", rainbowBtn)
        rainbowCorner.CornerRadius = UDim.new(0, 6)
        
        rainbowBtn.MouseButton1Click:Connect(function()
            Config[rainbowSetting] = not Config[rainbowSetting]
            rainbowBtn.BackgroundColor3 = Config[rainbowSetting] and Color3.fromRGB(147, 51, 234) or Color3.fromRGB(60, 60, 70)
        end)
        
        local function createRGBSlider(colorName, index, yPos)
            local track = Instance.new("Frame", colorFrame)
            track.Size = UDim2.new(1, -100, 0, 3)
            track.Position = UDim2.new(0, 55, 0, yPos)
            track.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
            track.BorderSizePixel = 0
            
            local trackCorner = Instance.new("UICorner", track)
            trackCorner.CornerRadius = UDim.new(1, 0)
            
            local fill = Instance.new("Frame", track)
            fill.Size = UDim2.new(Config[settingName][index] / 255, 0, 1, 0)
            fill.BackgroundColor3 = index == 1 and Color3.fromRGB(255, 0, 0) or (index == 2 and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(0, 0, 255))
            fill.BorderSizePixel = 0
            
            local fillCorner = Instance.new("UICorner", fill)
            fillCorner.CornerRadius = UDim.new(1, 0)
            
            local knob = Instance.new("Frame", track)
            knob.Size = UDim2.new(0, 10, 0, 10)
            knob.Position = UDim2.new(Config[settingName][index] / 255, -5, 0.5, -5)
            knob.BackgroundColor3 = Color3.new(1, 1, 1)
            knob.BorderSizePixel = 0
            
            local knobCorner = Instance.new("UICorner", knob)
            knobCorner.CornerRadius = UDim.new(1, 0)
            
            local colorLabel = Instance.new("TextLabel", colorFrame)
            colorLabel.Size = UDim2.new(0, 35, 0, 18)
            colorLabel.Position = UDim2.new(0, 12, 0, yPos - 7)
            colorLabel.BackgroundTransparency = 1
            colorLabel.Text = colorName .. ":"
            colorLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
            colorLabel.Font = Enum.Font.Gotham
            colorLabel.TextSize = 10
            colorLabel.TextXAlignment = Enum.TextXAlignment.Left
            
            local valueLabel = Instance.new("TextLabel", colorFrame)
            valueLabel.Size = UDim2.new(0, 35, 0, 18)
            valueLabel.Position = UDim2.new(1, -47, 0, yPos - 8)
            valueLabel.BackgroundTransparency = 1
            valueLabel.Text = tostring(Config[settingName][index])
            valueLabel.TextColor3 = Color3.fromRGB(147, 51, 234)
            valueLabel.Font = Enum.Font.GothamBold
            valueLabel.TextSize = 10
            
            local function updateColor(val)
                val = math.clamp(math.floor(val), 0, 255)
                Config[settingName][index] = val
                
                local percent = val / 255
                fill.Size = UDim2.new(percent, 0, 1, 0)
                knob.Position = UDim2.new(percent, -5, 0.5, -5)
                valueLabel.Text = tostring(val)
                
                local color = RGBToColor3(Config[settingName])
                preview.BackgroundColor3 = color
                
                Config[rainbowSetting] = false
                rainbowBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
                
                if settingName == "FOVColor" then FOVStroke.Color = color
                elseif settingName == "CrosshairColor" then
                    Crosshair.BackgroundColor3 = color
                    HorizontalLine.BackgroundColor3 = color
                    VerticalLine.BackgroundColor3 = color
                elseif settingName == "ESPColor" then 
                    for _, esp in pairs(ESPObjects) do
                        if esp.Highlight then
                            esp.Highlight.FillColor = color
                        end
                        if esp.Tracer then
                            esp.Tracer.BackgroundColor3 = color
                        end
                    end
                elseif settingName == "BoxColor" then
                    for _, esp in pairs(ESPObjects) do
                        if esp.BoxTop then esp.BoxTop.BackgroundColor3 = color end
                        if esp.BoxBottom then esp.BoxBottom.BackgroundColor3 = color end
                        if esp.BoxLeft then esp.BoxLeft.BackgroundColor3 = color end
                        if esp.BoxRight then esp.BoxRight.BackgroundColor3 = color end
                    end
                elseif settingName == "HighlightColor" then
                    TargetHighlight.FillColor = color
                elseif settingName == "NameColor" then
                    for _, esp in pairs(ESPObjects) do
                        if esp.NameLabel then
                            esp.NameLabel.TextColor3 = color
                        end
                        if esp.DistanceLabel then
                            esp.DistanceLabel.TextColor3 = color
                        end
                    end
                end
            end
            
            local dragging = false
            
            knob.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                    dragging = true
                end
            end)
            
            UserInputService.InputEnded:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                    dragging = false
                end
            end)
            
            UserInputService.InputChanged:Connect(function(input)
                if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
                    local mousePos = UserInputService:GetMouseLocation().X
                    local trackPos = track.AbsolutePosition.X
                    local trackSize = track.AbsoluteSize.X
                    local percent = math.clamp((mousePos - trackPos) / trackSize, 0, 1)
                    updateColor(percent * 255)
                end
            end)
        end
        
        createRGBSlider("R", 1, 40)
        createRGBSlider("G", 2, 65)
        createRGBSlider("B", 3, 90)
        
        return colorFrame
    end

    local function CreateAimPartSelector(parent)
        local selector = Instance.new("Frame", parent)
        selector.Size = UDim2.new(1, 0, 0, 65)
        selector.BackgroundColor3 = Color3.fromRGB(38, 38, 46)
        selector.BorderSizePixel = 0
        selector.LayoutOrder = #parent:GetChildren()
        
        local selectorCorner = Instance.new("UICorner", selector)
        selectorCorner.CornerRadius = UDim.new(0, 8)
        
        local label = Instance.new("TextLabel", selector)
        label.Size = UDim2.new(1, -20, 0, 22)
        label.Position = UDim2.new(0, 12, 0, 6)
        label.BackgroundTransparency = 1
        label.Text = "Target Body Part"
        label.TextColor3 = Color3.new(1, 1, 1)
        label.Font = Enum.Font.Gotham
        label.TextSize = 12
        label.TextXAlignment = Enum.TextXAlignment.Left
        
        local options = {"Head", "Body", "Torso", "Random"}
        
        for i, option in ipairs(options) do
            local btn = Instance.new("TextButton", selector)
            btn.Size = UDim2.new(0, 70, 0, 28)
            btn.Position = UDim2.new(0, 12 + ((i-1) * 75), 0, 32)
            btn.BackgroundColor3 = Config.AimPart == option and Color3.fromRGB(147, 51, 234) or Color3.fromRGB(60, 60, 70)
            btn.Text = option
            btn.TextColor3 = Color3.new(1, 1, 1)
            btn.Font = Enum.Font.GothamBold
            btn.TextSize = 11
            btn.AutoButtonColor = false
            
            local btnCorner = Instance.new("UICorner", btn)
            btnCorner.CornerRadius = UDim.new(0, 6)
            
            btn.MouseButton1Click:Connect(function()
                Config.AimPart = option
                for _, child in pairs(selector:GetChildren()) do
                    if child:IsA("TextButton") then
                        child.BackgroundColor3 = child.Text == option and Color3.fromRGB(147, 51, 234) or Color3.fromRGB(60, 60, 70)
                    end
                end
                if option == "Random" then RandomAimData.ShotCount = 0 end
            end)
        end
        
        return selector
    end

    local SavedConfigsLabel

    local function CreateConfigButtons(parent)
        local configFrame = Instance.new("Frame", parent)
        configFrame.Size = UDim2.new(1, 0, 0, 120)
        configFrame.BackgroundTransparency = 1
        configFrame.LayoutOrder = #parent:GetChildren()

        local slotLabel = Instance.new("TextLabel", configFrame)
        slotLabel.Size = UDim2.new(0.5, 0, 0, 22)
        slotLabel.Position = UDim2.new(0, 0, 0, 0)
        slotLabel.BackgroundTransparency = 1
        slotLabel.Text = "Config Slot: " .. CurrentConfigSlot
        slotLabel.TextColor3 = Color3.fromRGB(147, 51, 234)
        slotLabel.Font = Enum.Font.GothamBold
        slotLabel.TextSize = 12
        slotLabel.TextXAlignment = Enum.TextXAlignment.Left

        SavedConfigsLabel = Instance.new("TextLabel", configFrame)
        SavedConfigsLabel.Size = UDim2.new(0.5, 0, 0, 22)
        SavedConfigsLabel.Position = UDim2.new(0.5, 0, 0, 0)
        SavedConfigsLabel.BackgroundTransparency = 1
        SavedConfigsLabel.Text = "Saved: " .. GetSavedSlotsCount() .. "/" .. MaxConfigSlots
        SavedConfigsLabel.TextColor3 = Color3.fromRGB(34, 197, 94)
        SavedConfigsLabel.Font = Enum.Font.GothamBold
        SavedConfigsLabel.TextSize = 12
        SavedConfigsLabel.TextXAlignment = Enum.TextXAlignment.Right

        local slotSelector = Instance.new("Frame", configFrame)
        slotSelector.Size = UDim2.new(1, 0, 0, 30)
        slotSelector.Position = UDim2.new(0, 0, 0, 28)
        slotSelector.BackgroundTransparency = 1

        for i = 1, MaxConfigSlots do
            local slotBtn = Instance.new("TextButton", slotSelector)
            slotBtn.Size = UDim2.new(0, 55, 0, 28)
            slotBtn.Position = UDim2.new(0, (i-1) * 60, 0, 0)
            slotBtn.BackgroundColor3 = CurrentConfigSlot == i and Color3.fromRGB(147, 51, 234) or Color3.fromRGB(60, 60, 70)
            slotBtn.Text = tostring(i)
            slotBtn.TextColor3 = Color3.new(1, 1, 1)
            slotBtn.Font = Enum.Font.GothamBold
            slotBtn.TextSize = 12
            slotBtn.AutoButtonColor = false

            local slotCorner = Instance.new("UICorner", slotBtn)
            slotCorner.CornerRadius = UDim.new(0, 6)

            slotBtn.MouseButton1Click:Connect(function()
                CurrentConfigSlot = i
                slotLabel.Text = "Config Slot: " .. CurrentConfigSlot
                for _, child in pairs(slotSelector:GetChildren()) do
                    if child:IsA("TextButton") then
                        child.BackgroundColor3 = child.Text == tostring(i) and Color3.fromRGB(147, 51, 234) or Color3.fromRGB(60, 60, 70)
                    end
                end
            end)
        end

        local saveBtn = Instance.new("TextButton", configFrame)
        saveBtn.Size = UDim2.new(0.32, 0, 0, 30)
        saveBtn.Position = UDim2.new(0, 0, 0, 63)
        saveBtn.BackgroundColor3 = Color3.fromRGB(34, 197, 94)
        saveBtn.Text = "SAVE"
        saveBtn.TextColor3 = Color3.new(1, 1, 1)
        saveBtn.Font = Enum.Font.GothamBold
        saveBtn.TextSize = 12
        saveBtn.AutoButtonColor = false

        local saveCorner = Instance.new("UICorner", saveBtn)
        saveCorner.CornerRadius = UDim.new(0, 6)

        local loadBtn = Instance.new("TextButton", configFrame)
        loadBtn.Size = UDim2.new(0.32, 0, 0, 30)
        loadBtn.Position = UDim2.new(0.34, 0, 0, 63)
        loadBtn.BackgroundColor3 = Color3.fromRGB(59, 130, 246)
        loadBtn.Text = "LOAD"
        loadBtn.TextColor3 = Color3.new(1, 1, 1)
        loadBtn.Font = Enum.Font.GothamBold
        loadBtn.TextSize = 12
        loadBtn.AutoButtonColor = false

        local loadCorner = Instance.new("UICorner", loadBtn)
        loadCorner.CornerRadius = UDim.new(0, 6)

        local deleteBtn = Instance.new("TextButton", configFrame)
        deleteBtn.Size = UDim2.new(0.32, 0, 0, 30)
        deleteBtn.Position = UDim2.new(0.68, 0, 0, 63)
        deleteBtn.BackgroundColor3 = Color3.fromRGB(239, 68, 68)
        deleteBtn.Text = "DELETE"
        deleteBtn.TextColor3 = Color3.new(1, 1, 1)
        deleteBtn.Font = Enum.Font.GothamBold
        deleteBtn.TextSize = 12
        deleteBtn.AutoButtonColor = false

        local deleteCorner = Instance.new("UICorner", deleteBtn)
        deleteCorner.CornerRadius = UDim.new(0, 6)

        saveBtn.MouseButton1Click:Connect(function()
            SaveConfig()
            SavedConfigsLabel.Text = "Saved: " .. GetSavedSlotsCount() .. "/" .. MaxConfigSlots
        end)

        loadBtn.MouseButton1Click:Connect(function()
            if LoadConfig() then
                FOVCircle.Visible = Config.ShowFOV
                FOVCircle.Size = UDim2.new(0, Config.FOV, 0, Config.FOV)
                Crosshair.Visible = Config.ShowCrosshair
                HorizontalLine.Visible = Config.ShowCrosshair
                VerticalLine.Visible = Config.ShowCrosshair
                HorizontalLine.Size = UDim2.new(0, Config.CrosshairSize, 0, 2)
                VerticalLine.Size = UDim2.new(0, 2, 0, Config.CrosshairSize)
            end
        end)

        deleteBtn.MouseButton1Click:Connect(function()
            DeleteConfig()
            SavedConfigsLabel.Text = "Saved: " .. GetSavedSlotsCount() .. "/" .. MaxConfigSlots
        end)

        return configFrame
    end

    -- BUILD ALL SECTIONS
    local aimSection = CreateSection("[AIMBOT]")
    CreateToggle(aimSection, "Enable Aimbot", "AimEnabled")
    CreateToggle(aimSection, "Legit Mode (Long Range Only)", "LegitMode")
    CreateSlider(aimSection, "Legit Range (Distance)", 100, 500, "LegitRange", function(v) return tostring(math.floor(v)) .. " studs" end)
    CreateAimPartSelector(aimSection)
    CreateToggle(aimSection, "Wall Check", "WallCheck")

    local visualSection = CreateSection("[VISUALS]")
    CreateToggle(visualSection, "Show FOV Circle", "ShowFOV")
    CreateSlider(visualSection, "FOV Size", 50, 300, "FOV", function(v) return tostring(math.floor(v)) end)
    CreateColorSlider(visualSection, "FOV Color", "FOVColor", "RainbowFOV")
    CreateToggle(visualSection, "Show Crosshair", "ShowCrosshair")
    CreateSlider(visualSection, "Crosshair Size", 8, 30, "CrosshairSize", function(v) return tostring(math.floor(v)) end)
    CreateColorSlider(visualSection, "Crosshair Color", "CrosshairColor", "RainbowCrosshair")

    local espSection = CreateSection("[ESP FEATURES]")
    CreateToggle(espSection, "Enable Highlight ESP", "ESPEnabled")
    CreateToggle(espSection, "Enable 2D Box ESP", "BoxESPEnabled")
    CreateToggle(espSection, "Show Names", "ShowNames")
    CreateToggle(espSection, "Show Distance", "ShowDistance")
    CreateToggle(espSection, "Show Health Bar", "ShowHealthBar")
    CreateToggle(espSection, "Show Tracers", "ShowTracers")
    CreateSlider(espSection, "Name Spacing", 10, 30, "NameSpacing", function(v) return tostring(math.floor(v)) end)
    CreateToggle(espSection, "Team Check", "TeamCheck")
    CreateColorSlider(espSection, "ESP Color", "ESPColor", "RainbowESP")
    CreateColorSlider(espSection, "Box Color", "BoxColor", "RainbowBox")
    CreateColorSlider(espSection, "Name Color", "NameColor", "RainbowNames")

    local highlightSection = CreateSection("[TARGET HIGHLIGHT]")
    CreateToggle(highlightSection, "Enable Highlight", "HighlightEnabled")
    CreateColorSlider(highlightSection, "Highlight Color", "HighlightColor", "RainbowHighlight")

    local settingsSection = CreateSection("[SETTINGS]")
    CreateSlider(settingsSection, "Smoothness", 0.1, 0.8, "Smoothness", function(v) return string.format("%.2f", v) end)
    CreateSlider(settingsSection, "Max Distance", 100, 1000, "MaxDistance", function(v) return tostring(math.floor(v)) .. " studs" end)
    CreateSlider(settingsSection, "Prediction", 0, 0.5, "Prediction", function(v) return string.format("%.2f", v) end)
    CreateConfigButtons(settingsSection)

    -- TARGETING SYSTEM WITH IMPROVED FOV
    local function GetRandomAimPart()
        local parts = {"Head", "UpperTorso", "LowerTorso"}
        RandomAimData.ShotCount = RandomAimData.ShotCount + 1
        if RandomAimData.ShotCount >= RandomAimData.MaxShots then
            RandomAimData.ShotCount = 0
            RandomAimData.CurrentPart = "Head"
            return "Head"
        else
            RandomAimData.CurrentPart = parts[math.random(1, #parts)]
            return RandomAimData.CurrentPart
        end
    end

    local function IsVisible(targetPart)
        if not Config.WallCheck then return true end
        local origin = Camera.CFrame.Position
        local direction = (targetPart.Position - origin).Unit * Config.MaxDistance
        local params = RaycastParams.new()
        params.FilterDescendantsInstances = {LocalPlayer.Character}
        params.FilterType = Enum.RaycastFilterType.Exclude
        params.IgnoreWater = true
        local result = Workspace:Raycast(origin, direction, params)
        if result then return result.Instance:IsDescendantOf(targetPart.Parent) end
        return true
    end

    local function GetBodyPart(char)
        local aimPart = Config.AimPart
        if aimPart == "Random" then aimPart = GetRandomAimPart() end
        if aimPart == "Head" then return char:FindFirstChild("Head")
        elseif aimPart == "Body" then return char:FindFirstChild("UpperTorso") or char:FindFirstChild("Torso") or char:FindFirstChild("HumanoidRootPart")
        elseif aimPart == "Torso" then return char:FindFirstChild("LowerTorso") or char:FindFirstChild("Torso") or char:FindFirstChild("HumanoidRootPart")
        else return char:FindFirstChild(aimPart) or char:FindFirstChild("Head") or char:FindFirstChild("HumanoidRootPart")
        end
    end

    local function GetClosestTarget()
        local viewportSize = Camera.ViewportSize
        local center = Vector2.new(viewportSize.X / 2, viewportSize.Y / 2)
        local closest = nil
        local shortestDist = Config.FOV / 2
        
        for _, player in pairs(Players:GetPlayers()) do
            if player == LocalPlayer then continue end
            if Config.TeamCheck and player.Team == LocalPlayer.Team then continue end
            local char = player.Character
            if not char then continue end
            local hum = char:FindFirstChild("Humanoid")
            if not hum or hum.Health <= 0 then continue end
            local part = GetBodyPart(char)
            if not part then continue end
            local dist = (part.Position - Camera.CFrame.Position).Magnitude
            
            -- Check legit mode - only target if beyond legit range
            if Config.LegitMode and dist < Config.LegitRange then
                continue
            end
            
            if dist > Config.MaxDistance then continue end
            if not IsVisible(part) then continue end
            local pos, onScreen = Camera:WorldToViewportPoint(part.Position)
            if onScreen then
                local screenDist = (Vector2.new(pos.X, pos.Y) - center).Magnitude
                -- Proper FOV check - must be inside the circle
                if screenDist <= Config.FOV / 2 and screenDist < shortestDist then
                    shortestDist = screenDist
                    closest = char
                end
            end
        end
        return closest
    end

    -- MAIN AIM LOOP WITH FIXED TARGETING
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed then return end
        if input.UserInputType == Enum.UserInputType.MouseButton2 then
            if Config.AimEnabled then
                AimTarget = GetClosestTarget()
            end
        end
    end)

    UserInputService.InputEnded:Connect(function(input, gameProcessed)
        if gameProcessed then return end
        if input.UserInputType == Enum.UserInputType.MouseButton2 then
            AimTarget = nil
        end
    end)

    RunService.Heartbeat:Connect(function()
        if AimTarget and Config.AimEnabled then
            -- Show highlight ONLY on the current aimbot target
            if Config.HighlightEnabled then
                TargetHighlight.Adornee = AimTarget
                TargetHighlight.FillColor = RGBToColor3(Config.HighlightColor)
                TargetHighlight.Enabled = true
            else
                TargetHighlight.Enabled = false
            end
            
            local part = GetBodyPart(AimTarget)
            if part then
                local targetPos = part.Position
                local hum = AimTarget:FindFirstChild("Humanoid")
                if hum and Config.Prediction > 0 then
                    targetPos = targetPos + (part.Velocity * Config.Prediction)
                end
                if part.Name == "Head" then
                    targetPos = targetPos + Vector3.new(0, 0.05, 0)
                end
                local goalCF = CFrame.new(Camera.CFrame.Position, targetPos)
                Camera.CFrame = Camera.CFrame:Lerp(goalCF, Config.Smoothness)
            end
        else
            TargetHighlight.Enabled = false
        end
        
        -- Update ESP and FOV position
        UpdateFOVPosition()
        UpdateESP()
    end)

    -- RAINBOW EFFECTS
    RunService.Heartbeat:Connect(function()
        RainbowHue = (RainbowHue + 1) % 360
        local rainbowColor = Color3.fromHSV(RainbowHue / 360, 1, 1)
        
        if Config.RainbowFOV then
            Config.FOVColor = {math.floor(rainbowColor.R * 255), math.floor(rainbowColor.G * 255), math.floor(rainbowColor.B * 255)}
            FOVStroke.Color = rainbowColor
        end
        
        if Config.RainbowCrosshair then
            Config.CrosshairColor = {math.floor(rainbowColor.R * 255), math.floor(rainbowColor.G * 255), math.floor(rainbowColor.B * 255)}
            Crosshair.BackgroundColor3 = rainbowColor
            HorizontalLine.BackgroundColor3 = rainbowColor
            VerticalLine.BackgroundColor3 = rainbowColor
        end
        
        if Config.RainbowESP then
            Config.ESPColor = {math.floor(rainbowColor.R * 255), math.floor(rainbowColor.G * 255), math.floor(rainbowColor.B * 255)}
            for _, esp in pairs(ESPObjects) do
                if esp.Highlight then
                    esp.Highlight.FillColor = rainbowColor
                end
                if esp.Tracer then
                    esp.Tracer.BackgroundColor3 = rainbowColor
                end
            end
        end
        
        if Config.RainbowBox then
            Config.BoxColor = {math.floor(rainbowColor.R * 255), math.floor(rainbowColor.G * 255), math.floor(rainbowColor.B * 255)}
            for _, esp in pairs(ESPObjects) do
                local color = rainbowColor
                if esp.BoxTop then esp.BoxTop.BackgroundColor3 = color end
                if esp.BoxBottom then esp.BoxBottom.BackgroundColor3 = color end
                if esp.BoxLeft then esp.BoxLeft.BackgroundColor3 = color end
                if esp.BoxRight then esp.BoxRight.BackgroundColor3 = color end
            end
        end
        
        if Config.RainbowHighlight then
            Config.HighlightColor = {math.floor(rainbowColor.R * 255), math.floor(rainbowColor.G * 255), math.floor(rainbowColor.B * 255)}
            TargetHighlight.FillColor = rainbowColor
        end
        
        if Config.RainbowNames then
            Config.NameColor = {math.floor(rainbowColor.R * 255), math.floor(rainbowColor.G * 255), math.floor(rainbowColor.B * 255)}
            for _, esp in pairs(ESPObjects) do
                if esp.NameLabel then
                    esp.NameLabel.TextColor3 = rainbowColor
                end
                if esp.DistanceLabel then
                    esp.DistanceLabel.TextColor3 = rainbowColor
                end
            end
        end
    end)

    local function animateLoading()
        for i, step in ipairs(loadingSteps) do
            LoadingStatus.Text = step.text
            TweenService:Create(LoadingProgress, TweenInfo.new(0.3, Enum.EasingStyle.Quad), {Size = UDim2.new(step.progress, 0, 1, 0)}):Play()
            wait(0.4)
        end
        
        wait(0.3)
        LoadingGui:Destroy()
        
        -- Show FOV/Crosshair after loading
        FOVCircle.Visible = Config.ShowFOV
        Crosshair.Visible = Config.ShowCrosshair
        HorizontalLine.Visible = Config.ShowCrosshair
        VerticalLine.Visible = Config.ShowCrosshair
    end

    animateLoading()
    MainFrame.Visible = true
end
